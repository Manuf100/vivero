<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Compra - Vivero</title>
    <link href="CSS/formulario.css" rel="stylesheet" />
    <link href="CSS/sitemaster.css" rel="stylesheet" />
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <nav>
                <a href="index.html" class="botonImagen"><img class="imagenLogo" src="IMAGENES/logo.png" alt="Logo" /></a>
                <ul>
                    <li><a href="index.html">Inicio</a></li>
                    <li>
                        <a href="#">Productos</a>
                        <ul>
                            <li><a href="Plantas.html">Plantas</a></li>
                            <li><a href="Semillas.html">Semillas</a></li>
                            <li><a href="Macetas%20y%20Platos.html">Macetas y platos</a></li>
                            <li><a href="Herramienta.html">Herramienta</a></li>
                        </ul>
                    </li>
                    <li>
                        <a href="#">Vivero</a>
                        <ul>
                            <li><a href="Contacto.html">Contacto</a></li>
                            <li><a href="Locales.html">Locales</a></li>
                            <li><a href="Política%20de%20Devolución.html">Política de devolución</a></li>
                            <li><a href="Preguntas%20Frecuentes.html">Preguntas Frecuentes</a></li>
                        </ul>
                    </li>
                    <li><a href="Tips%20y%20cuidados.html">Tips y cuidados</a></li>
                    <li id="ventana">
                        <a href="#">Dashboard</a>
                        <ul>
                            <li><a href="crud.html">CRUD</a></li>
                            <li><a href="estadistica.html">ESTADISTICAS</a></li>
                            <li><a href="actualizaciones.html">ACTUALIZACIÓN MASIVA</a></li>
                        </ul>
                    </li>
                </ul>
                <script src="https://cdn.lordicon.com/lordicon.js"></script>
                <a href="Productos2.html"><lord-icon
                    src="https://cdn.lordicon.com/kkvxgpti.json"
                    trigger="hover"
                    style="width:100px;height:100px">
                </lord-icon></a>
            </nav>
            <script src="https://cdn.lordicon.com/lordicon.js"></script>
            <a href="Compra.html"><lord-icon
                src="https://cdn.lordicon.com/mfmkufkr.json"
                trigger="hover"
                style="width:100px;height:100px">
            </lord-icon></a>
            <a  href="is.html">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAG4AAABuCAYAAADGWyb7AAAAAXNSR0IArs4c6QAACbFJREFUeF7tnQWodEUUx/+fILaC2N2FHYiJBYLdjd2Fha0Y2IUtKjaKrSiK6GcHdhd2d2Pn/fnNwvp8u3Nu7Z25Owceb2Hnzj1z/nsmTs0YJYpSAmOi5DoxrQRcpD+CBFwCLlIJRMp20rgEXKQSiJTtpHEJuEglECnbSeMScJFKIFK2k8Yl4CKVQKRsD4vGTS5pWknTSPpF0meSPowUs3/ZbhNwy0paRdIsDiSAms59nrAHSF87ED91/wH0VUk3SfoiZGBjBm4SSatLWlvSGk6bqpL131m/T0u6zf09W1XHVfUTG3AzSlpf0lqSVpI0QVWC8PTzkaTbHYj3SPp1QO/t+ZpYgJtJ0qnZNLZp0wKT9JWkIyRdmP3/syl+QgduYkmHStpfUq91qinZvSZpT0ljm2AgVODga1tJx0mavgnB5HgnU+h+kt7I8UzppiECt5ykcyUtUnp0g+vgd0nnZLv0oyV9N4jXhgYc0yJaFitxNlxN0ut1DyAU4OADLdut7gEPoH80DvCeqvNdoQDHgZdtfhX0vNu6f5JtHr6U9LnbCfL5Y0lTZNPaVF1/U7vPC0jaUBJWlrL0s9sBcw6shZoGDiGyuC9fcnTPSLpO0rXZpubdkn1xmN9A0iaSJivZ106SLi7Zx6iPNwkc5qi7JS1YcGBo1PmSrqwArF4sYJVhdwuQRYk1+/CiD/d6rkngsII8LGm2nINiKjxJ0jU5nyvTHB45S3JuK0LHSzqsyIMhAgdPgPeIpFkNg2LdODJbg07P/v9laF9Hk7klXZ1N70sW6HwfSWcWeC64qbLDEOA9KGmOPoN6yE1Zb1c18JL9AMIZBfrY2k3tBR797yNNTpXdnPTSPIy52AVPa1DLegkZ7WMztFgOFP7I1nUMDE/keCZYjeulefjKVs42Bi+UHWTNz5+X8/z5nqRFJX1bhq9QNK4bPNa88Z3bZqD2vxKCPMbNDNYu7pC0prXxaO1CA66zYcET8FaZgTXw7AGSTsnx3lJnvBCByzH24JpyXjvWyBVT5exFp8wEnFHKOZqhdWifhVgf97A0HNkmAVdEav5nWKcJXrIQGxWMCrmoTcBNJIlDegg0p6SXjF77G7O2G+Vluk3A7ZoZdIlN4dxHlFbThHnsbCMTc+XdjLUJOHx5rBl3Ocv+90ah1dUM2T4maWnDCy7IeRZsVUBsBzjkxFGCc1LtnmgPKPO5AFsDdppS0jeWhrRpo8Z1xv6jc4yigU0SriemcR/xw0PzTNRm4BAAax0BPPw1RRjP3zQoCTtRs0O57cB1wMLLvpkktLAJ4v0WExd5Dx9YGBwW4JAF6x3Ca8KUtk7mRbjVAAjOWvyNXhom4BAGO01iSQa97mE0J3TdF8NCcBEge2nYgEMgeM+xKZ7glU61DQga2sHT5Q/WKLNhBK4jO0ICtxqgtWW9LDr7ZsNvgQhurw9ymIFDhi+7dQ/nZt3EOY3p0kcmd8+wA4cQca8QCHuvT6IVfP+cISeCMA2vdyEBNw4N8twOcrEtFeDTswvLOmfaoFiB4+RPAGvIRMic5azUbwzEam5R4yAPdDGh/V7BsQVTWV+yAmdRcd+7Yvke3xipynVUZbCe57y4eBs4aQ8TcAyZTQRJKMRzVkmLu6IAvj6JuembZ56A6y1CYiCxZJzlk3KO7wllf8fQnlIfZBn1pAScX4oEvRKB/Ju/qbcFlhOLn3AeX2pyAs4ra/3k6qmQoFIFWbzzC2dHlBeTxhUXd9UOWfIBLRHMxKz0zZNIGtcbVFwxWxqnNutPgxwJy26VmmN9S1Il4P4vcqayoyQRVl41ka6Mmc1HRKxRLK705oQTP5FIIdMMksigKUMk3m+eBfjcWaaTPs9aznE4eyf1vd+qcb5+Qvi+O1ioCD9owro1O1oxq53oYQ7PgLfGSwJunBQH5eK53B0t+mF3Qzadbuz75Q07cBiXKYpzsk9QFX1P0BA7xn6ERh7ie98wA4dZizCGQbhzwAFrCAVNfUSVBzSzLw0rcHUaknsJnOmPWiw+MkV6DSNwmLC28RlxfdIt8L2lehIHftPufZiAq8NobMWPElSUoyLaqx9RvHQXS6fDAhxWCMITqnbTWGRMG2uaMec8U/2vYQCOotiUdqKEVBM0nqT3XTGefu/Hhompi9qXXmo7cNT52rEil4xXmD0aYImhGpGPSA7Z3deo831bgcN3RmLhRVZB1NiOHSxuGh+Rekw+nYnaCBxTIlMjU2TTRK1mwu18RNrxQr5G3d+3DTg81SzwIdzSQWE5bg3B0u8jIstyVQNsE3B4BkKpRIRc8ZhbKi9QGBUzWK6KgG0CzverHuT31ikSnqhzQu56LkrA5RKXqfH8mQ30FVPLcTl73uDX0fpKwBklbGxGiSdSgq2XXFAC8VFj3/9ploArIrXRnwGsxyXNbOwSg3Phu4JCBO5gZ0FgnYiFCJu4LztoEw9pIWpxUkS8sDUnNOC6bXqXOKuHJQ7RIqy62jA93u8uHLS8g/Gs6oC2tB+1TUjAoWkj03tvkbSdMRaxsBBKPMjFg1fkvHSwkorooQCHq54BjUZcfwl4dUVeFcGNQzXVESyFZ7r7ZzrlOtDSFAJwVpfHpdlNUfsO6raoPpJdwVUyt5Tc7+4GsxYHchL0S1PTwOW9vQrt20vS9aVHnr8DXC4UEcWslpfIMacYG/xXQk0CRwbpkwVHgYufqQotrLtGJdHHpFttX5BXwKLUExFelVGTwDEIYj/YPeJsLEKkLFGxhzgSis4QnlAFUfcSPxrnrCVKdIhlhCvJLPkCuV7TNHAwS942U5/Fit5vcGjeAy48AQMvawrnJQthpsKtgpCxZqBlZQmLCGOzZOfkflcIwMH0UtklCmz9OchWSdwZxyW0uHk6d8lxfzjBO9wbxwajkK3Qw+RVWXDQznVO46EAhxwo4MKUx68+ViLDZu9BeN5DAq4DFjdWNVlfsuiPBl8gQa+5K5oXeWGIwDEOnKIEz2AaCp3YIHFJBFeMmSK0qhhQqMB1xsbiTszGvFUMtoY+OI6QOjXwUInQgUPWHBUIZuXGQ2/eWA3gjOyS+iOXORMd8ZKNUAzAdQuGxENqPhLFNWii5C67RabEyiwgRQcRG3CdcZJqSzQXaVKsg97U24ICIkuVkHDOmdx8HAzFCtxIAWIHxOq+YmZBWcbd9V1EyJS+4jbFsc5fNvC1y8p0W4AbOV7KUnDZEF5mn0WGdYotfAgBtFbcWnVhhHnQbWjYVo1rAzZ9x5CAixTiBFwCLlIJRMp20rgEXKQSiJTtpHEJuEglECnbSeMScJFKIFK2k8Yl4CKVQKRs/wOU64x+ASXEwQAAAABJRU5ErkJggg=="/>
            </a>
        </div>
    </header>
    <hr class="barra-header"/>
    </br></br></br></br></br></br></br></br>
    <hr class="barra-header"/>
    <main>
        <h2>Carrito de compras</h2>
        <div id="carrito">
            <!-- Aquí se mostrará el producto cargado del almacenamiento local -->
        </div>
        <p id="lblTotal"></p>

            <h2>Formulario de Datos</h2>
            <div id="panelFormulario">
                <div class="form-group">
                    <label for="nombre">Nombre: (*)</label>
                    <input type="text" id="txtNombre" class="form-control" />
                    <span class="text-danger" id="rfvNombre" style="display:none; color:red;">El nombre es obligatorio.</span>
                </div>
                <div class="form-group">
                    <label for="apellido">Apellido: (*)</label>
                    <input type="text" id="txtApellido" class="form-control" />
                    <span class="text-danger" id="rfvApellido" style="display:none; color:red;">El apellido es obligatorio.</span>
                </div>
                <div class="form-group">
                    <label for="mail">Email: (*)</label>
                    <input type="email" id="txtEmail" class="form-control" />
                    <span class="text-danger" id="rfvEmail" style="display:none; color:red;">El email es obligatorio.</span>
                    <span class="text-danger" id="revEmail" style="display:none; color:red;">El email no es válido.</span>
                </div>
                <div class="form-group">
                    <label for="direccion">Dirección: (*)</label>
                    <input type="text" id="txtDireccion" class="form-control" />
                    <span class="text-danger" id="rfvDireccion" style="display:none; color:red;">La dirección es obligatoria.</span>
                </div>
                <div class="form-group">
                    <label for="numero">Número: (*)</label>
                    <input type="number" id="txtNumero" class="form-control" />
                    <span class="text-danger" id="rfvNumero" style="display:none; color:red;">El número es obligatorio.</span>
                </div>
                <div class="form-group">
                    <label for="ciudad">Ciudad: (*)</label>
                    <input type="text" id="txtCiudad" class="form-control" />
                    <span class="text-danger" id="rfvCiudad" style="display:none; color:red;">La ciudad es obligatoria.</span>
                </div>
                <div class="form-group">
                    <label for="provincia">Provincia: (*)</label>
                    <input type="text" id="txtProvincia" class="form-control" />
                    <span class="text-danger" id="rfvProvincia" style="display:none; color:red;">La provincia es obligatoria.</span>
                </div>
                <div class="form-group">
                    <label for="pais">País: (*)</label>
                    <input type="text" id="txtPais" class="form-control" />
                    <span class="text-danger" id="rfvPais" style="display:none; color:red;">El país es obligatorio.</span>
                </div>
                <div class="form-group">
                    <label for="codigoPostal">Código Postal: (*)</label>
                    <input type="text" id="txtCodigoPostal" class="form-control" />
                    <span class="text-danger" id="rfvCodigoPostal" style="display:none; color:red;">El código postal es obligatorio.</span>
                </div>
                <div class="form-group">
                    <label for="medioPago">Medio de Pago: (*)</label>
                    <select id="ddlMedioPago" class="form-control">
                        <option value="">Seleccionar...</option>
                        <option value="Efectivo">Efectivo</option>
                        <option value="Transferencia">Transferencia</option>
                        <option value="Debito">Débito</option>
                        <option value="Credito">Crédito</option>
                    </select>
                    <span class="text-danger" id="rfvMedioPago" style="display:none; color:red;">Debe seleccionar un medio de pago.</span>
                </div>
                <div class="form-group">
                    <label for="comentarios">Comentarios:</label>
                    <textarea id="txtComentarios" class="form-control" rows="4"></textarea>
                </div>
                <p style="color:#6b6b6b; font-size:12px">(*) son obligatorios</p>
                <div class="form-group">
                    <button id="btnEnviar" class="btn btn-primary">Enviar</button>
                </div>
                <div class="form-group" >
                    <a id="desc" style="display:none;" href="http://localhost/vivero/public_html/php/resumen_pedido.txt" download="http://localhost/vivero/public_html/php/resumen_pedido.txt">
                        <button>Descargar Resumen de Compra</button>
                    </a>
                    
                </div>
            </div>
        </div>
    </main>
    <div style="height: 150px; overflow: hidden;"><svg viewBox="0 0 500 150" preserveAspectRatio="none" style="height: 100%; width: 100%;"><path d="M-1.02,96.04 C148.52,176.83 348.85,-3.45 501.79,99.00 L500.00,149.74 L0.00,149.74 Z" style="stroke: none; fill: black;"></path></svg></div>
    <!-- Footer -->
    <footer>
        <section class="top">
            <ul>
                <li>
                    <h3>PRODUCTOS</h3>
                    <a href="Plantas.html">Plantas</a>
                    <a href="Macetas%20y%20Platos.html">Macetas y Platos</a>
                    <a href="Semillas.html">Semillas</a>
                    <a href="Herramienta.html">Herramienta</a>
                </li>
                <li>
                    <h3>Vivero</h3>
                    <a href="Contacto.html">Contacto</a>
                    <a href="Locales.html">Locales</a>
                    <a href="Política%20de%20Devolución.html">Política de Devolución</a>
                    <a href="Preguntas%20Frecuentes.html">Preguntas Frecuentes</a>
                </li>
                <li>
                    <h3>Tips</h3>
                    <a href="Tips%20y%20cuidados.html">Tips y cuidados</a>
                </li>
            </ul>
        </section>
        <section class="bottom">2024 Página hecha por Manuel Figueroa</section>
    </footer>
    <script>
        var total;
        // Función para mostrar el carrito de compras
        function mostrarCarrito() {
            var productosEnCarrito = JSON.parse(localStorage.getItem('productosEnCarrito')) || [];
            var cantidadesEnCarrito = JSON.parse(localStorage.getItem('cantidadesEnCarrito')) || [];
            var preciosEnCarrito = JSON.parse(localStorage.getItem('preciosEnCarrito')) || [];

            var carritoDiv = document.getElementById('carrito');
            carritoDiv.innerHTML = '';

            if (productosEnCarrito.length > 0) {
                total = 0;
                for (var i = 0; i < productosEnCarrito.length; i++) {
                    var producto = productosEnCarrito[i];
                    var cantidad = cantidadesEnCarrito[i];
                    var precioTotal = preciosEnCarrito[i];

                    total += precioTotal;

                    var productoControl = document.createElement('div');
                    productoControl.innerHTML = `<p>- ${producto} - Cantidad: ${cantidad} - Precio Total: $${precioTotal}</p>`;
                    carritoDiv.appendChild(productoControl);
                }
                document.getElementById('lblTotal').innerHTML = `Total de la compra: $<u>${total.toFixed(2)}</u>`;
            } else {
                document.getElementById('lblTotal').innerHTML = 'El carrito está vacío.';
            }
        }

        function enviarFormulario() {
            var nombre = document.getElementById('txtNombre').value;
            var apellido = document.getElementById('txtApellido').value;
            var email = document.getElementById('txtEmail').value;
            var direccion = document.getElementById('txtDireccion').value;
            var numero = document.getElementById('txtNumero').value;
            var ciudad = document.getElementById('txtCiudad').value;
            var provincia = document.getElementById('txtProvincia').value;
            var pais = document.getElementById('txtPais').value;
            var codigoPostal = document.getElementById('txtCodigoPostal').value;
            var medioPago = document.getElementById('ddlMedioPago').value;
            var comentarios = document.getElementById('txtComentarios').value;
            var id_usuario=localStorage.getItem('id_usuario');

            if (validarFormulario()) {
                // Obtener productos y cantidades del carrito
                var productosEnCarrito = JSON.parse(localStorage.getItem('productosEnCarrito')) || [];
                var cantidadesEnCarrito = JSON.parse(localStorage.getItem('cantidadesEnCarrito')) || [];

                // Crear objeto FormData
                var formData = new FormData();
                formData.append('nombre', nombre);
                formData.append('apellido', apellido);
                formData.append('email', email);
                formData.append('direccion', direccion);
                formData.append('numero', numero);
                formData.append('ciudad', ciudad);
                formData.append('provincia', provincia);
                formData.append('pais', pais);
                formData.append('codigoPostal', codigoPostal);
                formData.append('medioPago', medioPago);
                formData.append('comentarios', comentarios);
                formData.append('productosEnCarrito', JSON.stringify(productosEnCarrito));
                formData.append('cantidadesEnCarrito', JSON.stringify(cantidadesEnCarrito));
                formData.append('id_usuario', id_usuario);
                formData.append('total', total);

                // Enviar datos al archivo PHP
                fetch('http://localhost/vivero/public_html/php/procesar_pedido.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.text())
                .then(data => {
                    // Procesar respuesta del servidor
                    console.log(data);
                    alert('Compra realizada con éxito.');
                    // Limpiar el carrito
                    localStorage.removeItem('productosEnCarrito');
                    localStorage.removeItem('cantidadesEnCarrito');
                    localStorage.removeItem('preciosEnCarrito');
                    document.getElementById("desc").style.display = "block";
                    //window.location.href = 'Compra.html'; // Redirigir a la página de confirmación
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
        }

        function validarFormulario() {
        var esValido = true;
        
        // Obtener los valores de los campos
        var nombre = document.getElementById('txtNombre').value;
        var apellido = document.getElementById('txtApellido').value;
        var email = document.getElementById('txtEmail').value;
        var direccion = document.getElementById('txtDireccion').value;
        var numero = document.getElementById('txtNumero').value;
        var ciudad = document.getElementById('txtCiudad').value;
        var provincia = document.getElementById('txtProvincia').value;
        var pais = document.getElementById('txtPais').value;
        var codigoPostal = document.getElementById('txtCodigoPostal').value;
        var medioPago = document.getElementById('ddlMedioPago').value;

        // Validar nombre
        if (nombre.trim() === '') {
            document.getElementById('rfvNombre').style.display = 'inline';
            esValido = false;
        } else {
            document.getElementById('rfvNombre').style.display = 'none';
        }

        // Validar apellido
        if (apellido.trim() === '') {
            document.getElementById('rfvApellido').style.display = 'inline';
            esValido = false;
        } else {
            document.getElementById('rfvApellido').style.display = 'none';
        }

        // Validar email
        if (email.trim() === '') {
            document.getElementById('rfvEmail').style.display = 'inline';
            document.getElementById('revEmail').style.display = 'none';
            esValido = false;
        } else if (!validarEmail(email)) {
            document.getElementById('revEmail').style.display = 'inline';
            esValido = false;
        } else {
            document.getElementById('rfvEmail').style.display = 'none';
            document.getElementById('revEmail').style.display = 'none';
        }

        // Validar dirección
        if (direccion.trim() === '') {
            document.getElementById('rfvDireccion').style.display = 'inline';
            esValido = false;
        } else {
            document.getElementById('rfvDireccion').style.display = 'none';
        }

        // Validar número
        if (numero.trim() === '') {
            document.getElementById('rfvNumero').style.display = 'inline';
            esValido = false;
        } else {
            document.getElementById('rfvNumero').style.display = 'none';
        }

        // Validar ciudad
        if (ciudad.trim() === '') {
            document.getElementById('rfvCiudad').style.display = 'inline';
            esValido = false;
        } else {
            document.getElementById('rfvCiudad').style.display = 'none';
        }

        // Validar provincia
        if (provincia.trim() === '') {
            document.getElementById('rfvProvincia').style.display = 'inline';
            esValido = false;
        } else {
            document.getElementById('rfvProvincia').style.display = 'none';
        }

        // Validar país
        if (pais.trim() === '') {
            document.getElementById('rfvPais').style.display = 'inline';
            esValido = false;
        } else {
            document.getElementById('rfvPais').style.display = 'none';
        }

        // Validar código postal
        if (codigoPostal.trim() === '') {
            document.getElementById('rfvCodigoPostal').style.display = 'inline';
            esValido = false;
        } else {
            document.getElementById('rfvCodigoPostal').style.display = 'none';
        }

        // Validar medio de pago
        if (medioPago === '') {
            document.getElementById('rfvMedioPago').style.display = 'inline';
            esValido = false;
        } else {
            document.getElementById('rfvMedioPago').style.display = 'none';
        }

        return esValido;
    }

    function validarEmail(email) {
        var regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return regex.test(email);
    }

        function generarResumenDeCompra(nombre, apellido, email, direccion, numero, ciudad, provincia, pais, codigoPostal, medioPago, comentarios, productos, cantidades) {
            var resumen = "Resumen de Compra:\n\n";
            resumen += "Nombre: " + nombre + "\n";
            resumen += "Apellido: " + apellido + "\n";
            resumen += "Email: " + email + "\n";
            resumen += "Dirección: " + direccion + ", " + numero + "\n";
            resumen += "Ciudad: " + ciudad + "\n";
            resumen += "Provincia: " + provincia + "\n";
            resumen += "País: " + pais + "\n";
            resumen += "Código Postal: " + codigoPostal + "\n";
            resumen += "Medio de Pago: " + medioPago + "\n";
            resumen += "Comentarios: " + comentarios + "\n\n";
            resumen += "Productos:\n";

            for (var i = 0; i < productos.length; i++) {
                resumen += productos[i] + " - Cantidad: " + cantidades[i] + "\n";
            }
            resumen+="Total"+total;

            return resumen;
        }

        document.getElementById('btnEnviar').onclick = enviarFormulario;
        window.onload = mostrarCarrito;
    </script>
    <script>
        let tipo;
        tipo=localStorage.getItem('tipo_cliente');
        if (tipo === 'Dueño') {
            document.getElementById('ventana').style.display = 'block';
        }
        else{
            document.getElementById('ventana').style.display = 'none';
        }
    </script>
</body>
</html>
